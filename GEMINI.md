# LyricLens - AI Music Video Generator

LyricLens is an AI-powered application that turns audio tracks into synchronized, visually stylistic lyric videos. It leverages Google's Gemini models for transcription, lyric analysis, and image generation, combined with a hybrid client-server rendering pipeline to produce high-quality MP4 exports.

## Project Overview

-   **Frontend:** React (Vite), TypeScript, Tailwind CSS, Shadcn UI.
-   **Backend:** Node.js (Express), FFmpeg (Video Stitching), yt-dlp (YouTube Import).
-   **AI Engine:** Google Gemini (via `@google/genai` SDK).
-   **Core Feature:** Generates word-level synchronized lyrics, analyzes song structure to create prompt-based visual storyboards, and renders a final video with audio visualization.

## Architecture

The project uses a **hybrid rendering approach** to balance interactivity and performance:

1.  **Client-Side Rendering (Canvas):** The browser renders each frame of the video onto an HTML5 Canvas. This includes:
    *   The background image (generated by Gemini).
    *   The audio visualizer (FFT frequency data).
    *   The synchronized subtitles (word-level highlighting).
    *   Visual effects (Ken Burns zoom, gradients, glow).

2.  **Frame Upload:** The client converts these canvas frames to JPEG blobs and uploads them to the server in batches (chunks).

3.  **Server-Side Stitching:** The Express server receives the frames and the original audio, then spawns an `ffmpeg` process to stitch them together into a final MP4 video file.

## Key Files & Services

### Frontend
*   **`App.tsx`**: Main application state and UI layout. Manages the lifecycle of song data, prompts, and generation status.
*   **`services/geminiService.ts`**: The bridge to Google's Gemini API.
    *   **Transcription:** Uses `gemini-3-pro-preview` to generate precise JSON word-level timings.
    *   **Prompt Generation:** Uses `gemini-3-flash-preview` to analyze lyrics and generate style-consistent image prompts.
    *   **Image Generation:** Uses `gemini-2.5-flash-image` (Imagen 3) to generate high-quality assets.
    *   **Translation:** Uses `gemini-3-flash-preview` to translate lyrics while preserving poetic flow.
*   **`services/ffmpegService.ts`**: Handles the complex logic of rendering frames to canvas and managing the upload protocol (`/api/export/init`, `/chunk`, `/finalize`).
*   **`utils/audioAnalysis.ts`**: Extracts frequency data from audio for the visualizer.

### Backend (`server/`)
*   **`server/index.ts`**:
    *   **`/api/export/*`**: Manages temporary sessions, handles multi-part frame uploads, and runs the FFmpeg build command.
    *   **`/api/import/youtube`**: Spawns `yt-dlp` to download audio from a provided URL.
    *   **Temp Management**: Automatically creates and cleans up session directories in `temp/`.

## Setup & Usage

### Prerequisites
*   Node.js (v18+)
*   FFmpeg installed and available in system PATH.
*   `yt-dlp` (optional, for YouTube import) available in system PATH.
*   Google Gemini API Key.

### Environment
Create a `.env.local` file in the root:
```env
GEMINI_API_KEY=your_api_key_here
```

### Commands
| Command | Description |
| :--- | :--- |
| `npm run dev:all` | **Recommended.** Runs both the Vite frontend and Express server concurrently. |
| `npm run dev` | Runs only the frontend (localhost:5173). |
| `npm run server` | Runs only the backend (localhost:3001). |
| `npm test` | Runs the test suite (`test/runTest.ts`). |

## Development Conventions

*   **Type Safety:** Strict TypeScript usage for all interfaces (`types.ts`).
*   **AI Reliability:** AI calls use `responseSchema` (JSON mode) to ensure deterministic parsing of complex data like timing and prompts.
*   **Rendering Loop:** The render loop in `ffmpegService.ts` must handle frame-perfect synchronization. When modifying visual effects, ensure they are performant enough for canvas rendering at 30fps.
*   **File Handling:** The backend uses `multer` for handling binary streams. Ensure `temp/` directory permissions are correct on deployment.
